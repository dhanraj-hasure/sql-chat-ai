<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SQL Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #ffffff;
            color: #1f1f1f;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .header {
            padding: 16px 24px;
            border-bottom: 1px solid #e8eaed;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: #000;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
        }

        .settings-btn {
            background: #000;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .settings-btn:hover {
            background: #333;
        }

        .clear-btn {
            background: #fff;
            color: #000;
            border: 1px solid #e8eaed;
            padding: 10px 20px;
            border-radius: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .clear-btn:hover {
            background: #f8f9fa;
            border-color: #000;
        }

        .schema-btn {
            background: #fff;
            color: #000;
            border: 1px solid #e8eaed;
            padding: 10px 20px;
            border-radius: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .schema-btn:hover {
            background: #f8f9fa;
            border-color: #000;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #f8f9fa;
        }

        .welcome {
            max-width: 800px;
            margin: 60px auto;
            text-align: center;
        }

        .welcome h1 {
            font-size: 48px;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #4285f4, #34a853, #fbbc04, #ea4335);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome p {
            font-size: 18px;
            color: #5f6368;
        }

        .message {
            max-width: 800px;
            margin: 0 auto 24px;
            display: flex;
            gap: 16px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #000;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
            background: #fff;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .message.user .message-content {
            background: #e8f0fe;
        }

        .sql-block {
            background: #f8f9fa;
            border: 1px solid #e8eaed;
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
        }

        .results-table {
            margin: 12px 0;
            overflow-x: auto;
            max-width: 100%;
            border: 1px solid #e8eaed;
            border-radius: 8px;
            position: relative;
        }

        .results-table::after {
            content: '← Scroll →';
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .results-table.has-scroll::after {
            opacity: 1;
        }

        .results-table::-webkit-scrollbar {
            height: 8px;
        }

        .results-table::-webkit-scrollbar-track {
            background: #f1f3f4;
            border-radius: 4px;
        }

        .results-table::-webkit-scrollbar-thumb {
            background: #dadce0;
            border-radius: 4px;
        }

        .results-table::-webkit-scrollbar-thumb:hover {
            background: #bdc1c6;
        }

        table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
            background: #fff;
        }

        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 500;
            border-bottom: 2px solid #e8eaed;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f1f3f4;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        td:hover {
            overflow: visible;
            white-space: normal;
            word-break: break-word;
        }

        /* Input Area */
        .input-area {
            padding: 16px 24px;
            background: #fff;
            border-top: 1px solid #e8eaed;
        }

        .input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e8eaed;
            border-radius: 24px;
            font-size: 15px;
            font-family: inherit;
            resize: none;
            max-height: 200px;
        }

        .input-field:focus {
            outline: none;
            border-color: #4285f4;
        }

        .send-btn {
            background: #000;
            color: #fff;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .send-btn:hover {
            background: #333;
        }

        .send-btn:disabled {
            background: #e8eaed;
            color: #5f6368;
            cursor: not-allowed;
        }

        .mode-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            justify-content: center;
        }

        .mode-btn {
            padding: 8px 16px;
            border: 1px solid #e8eaed;
            background: #fff;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        .mode-btn.active {
            background: #000;
            color: #fff;
            border-color: #000;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.open {
            display: flex;
        }

        .modal-content {
            background: #fff;
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 500;
        }

        .close-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }

        .close-btn:hover {
            background: #f1f3f4;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #1f1f1f;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e8eaed;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4285f4;
        }

        .save-btn {
            background: #000;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            width: 100%;
        }

        .save-btn:hover {
            background: #333;
        }

        .status {
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .status.success {
            background: #e6f4ea;
            color: #137333;
        }

        .status.error {
            background: #fce8e6;
            color: #c5221f;
        }

        .info-box {
            background: #e8f0fe;
            color: #1967d2;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }

        .info-box .material-icons {
            font-size: 18px;
        }

        /* Schema Overlay */
        .schema-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .schema-overlay.open {
            display: flex;
        }

        .schema-overlay-content {
            background: #fff;
            border-radius: 16px;
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .schema-overlay-header {
            padding: 24px;
            border-bottom: 1px solid #e8eaed;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .schema-overlay-title {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .schema-overlay-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .schema-overlay-close:hover {
            background: #f1f3f4;
        }

        .schema-overlay-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .schema-tables {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .schema-table-card {
            background: #f8f9fa;
            border: 1px solid #e8eaed;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }

        .schema-table-card:hover {
            border-color: #000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .schema-table-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #000;
        }

        .schema-table-name .material-icons {
            color: #4285f4;
        }

        .schema-columns {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .schema-column {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #fff;
            border-radius: 6px;
            font-size: 14px;
        }

        .schema-column-name {
            font-weight: 500;
            color: #1f1f1f;
            flex: 1;
        }

        .schema-column-type {
            color: #5f6368;
            font-size: 12px;
            background: #e8eaed;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .schema-empty {
            text-align: center;
            padding: 60px 20px;
            color: #5f6368;
        }

        .schema-empty .material-icons {
            font-size: 64px;
            color: #e8eaed;
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            .welcome h1 {
                font-size: 32px;
            }

            .modal-content {
                padding: 24px;
            }

            .header-actions {
                gap: 8px;
            }

            .schema-btn,
            .clear-btn,
            .settings-btn {
                padding: 8px 12px;
                font-size: 13px;
            }

            .schema-btn span,
            .clear-btn span,
            .settings-btn span {
                font-size: 18px;
            }

            .schema-overlay-content {
                width: 95%;
                height: 95vh;
            }

            .schema-tables {
                grid-template-columns: 1fr;
            }

            .schema-overlay-header {
                padding: 16px;
            }

            .schema-overlay-title {
                font-size: 18px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">
                    <span class="material-icons">storage</span>
                </div>
                <span>SQL Chat</span>
            </div>
            <div class="header-actions">
                <button class="schema-btn" onclick="openSchemaOverlay()">
                    <span class="material-icons">table_view</span>
                    View Schema
                </button>
                <button class="clear-btn" onclick="clearChatHistory()">
                    <span class="material-icons">delete_outline</span>
                    Clear Chat
                </button>
                <button class="settings-btn" onclick="openSettings()">
                    <span class="material-icons">settings</span>
                    Settings
                </button>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area" id="chatArea">
            <div class="welcome" id="welcome">
                <h1>Talk to Your Database</h1>
                <p>Configure your API key and database credentials to get started</p>
            </div>
            <div id="messages"></div>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="setMode('ai')" id="aiModeBtn">AI Query</button>
                <button class="mode-btn" onclick="setMode('sql')" id="sqlModeBtn">Direct SQL</button>
            </div>
            <div class="input-wrapper">
                <textarea id="inputField" class="input-field" placeholder="Ask a question about your data..." rows="1"
                    onkeydown="handleKeyPress(event)"></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    <span class="material-icons">send</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="close-btn" onclick="closeSettings()">
                    <span class="material-icons">close</span>
                </button>
            </div>

            <div id="statusMessage"></div>

            <div class="info-box">
                <span class="material-icons">info</span>
                <div>
                    <strong>Data Persistence:</strong> Your credentials and chat history are saved in your browser's
                    localStorage. They will persist even after you close the browser. Click "Clear Chat" to remove chat
                    history or clear browser data to reset everything.
                </div>
            </div>

            <div class="form-group">
                <label>AI Provider</label>
                <select id="aiProvider" onchange="updateApiKeyLabel()">
                    <option value="gemini">Google Gemini</option>
                    <option value="openai">OpenAI</option>
                </select>
            </div>

            <div class="form-group">
                <label id="apiKeyLabel">Gemini API Key</label>
                <input type="password" id="apiKey" placeholder="Enter your API key">
            </div>

            <div class="form-group">
                <label>Database Type</label>
                <select id="dbType">
                    <option value="postgresql">PostgreSQL</option>
                    <option value="mysql">MySQL</option>
                </select>
            </div>

            <div class="form-group">
                <label>Database Host</label>
                <input type="text" id="dbHost" placeholder="localhost">
            </div>

            <div class="form-group">
                <label>Database Port</label>
                <input type="text" id="dbPort" placeholder="5432">
            </div>

            <div class="form-group">
                <label>Database Name</label>
                <input type="text" id="dbName" placeholder="mydatabase">
            </div>

            <div class="form-group">
                <label>Database Username</label>
                <input type="text" id="dbUser" placeholder="username">
            </div>

            <div class="form-group">
                <label>Database Password</label>
                <input type="password" id="dbPassword" placeholder="password">
            </div>

            <button class="save-btn" onclick="saveSettings()">Save & Connect</button>
        </div>
    </div>

    <!-- Schema Overlay -->
    <div class="schema-overlay" id="schemaOverlay">
        <div class="schema-overlay-content">
            <div class="schema-overlay-header">
                <div class="schema-overlay-title">
                    <span class="material-icons">table_view</span>
                    Database Schema
                </div>
                <button class="schema-overlay-close" onclick="closeSchemaOverlay()">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="schema-overlay-body" id="schemaOverlayBody">
                <div class="schema-empty">
                    <span class="material-icons">storage</span>
                    <p>Loading schema...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let config = {
            aiProvider: 'gemini',
            apiKey: '',
            dbType: 'postgresql',
            dbHost: 'localhost',
            dbPort: '5432',
            dbName: '',
            dbUser: '',
            dbPassword: ''
        };
        let mode = 'ai';
        let schema = '';
        let chatHistory = [];

        // Load config from localStorage
        function loadConfig() {
            const saved = localStorage.getItem('sqlChatConfig');
            if (saved) {
                config = JSON.parse(saved);
                updateFormFields();
            }
        }

        // Load chat history from localStorage
        function loadChatHistory() {
            const saved = localStorage.getItem('sqlChatHistory');
            if (saved) {
                try {
                    chatHistory = JSON.parse(saved);
                    // Restore all messages
                    chatHistory.forEach(msg => {
                        if (msg.type === 'user') {
                            addUserMessage(msg.content, false);
                        } else if (msg.type === 'assistant') {
                            addAssistantMessage(msg.sqlQuery, msg.results, msg.summary, false);
                        } else if (msg.type === 'error') {
                            addErrorMessage(msg.content, false);
                        }
                    });
                    if (chatHistory.length > 0) {
                        document.getElementById('welcome').style.display = 'none';
                    }
                    // Add scroll indicators after loading
                    addScrollIndicator();
                } catch (e) {
                    console.error('Failed to load chat history:', e);
                    chatHistory = [];
                }
            }
        }

        // Save chat history to localStorage
        function saveChatHistory() {
            try {
                localStorage.setItem('sqlChatHistory', JSON.stringify(chatHistory));
            } catch (e) {
                console.error('Failed to save chat history:', e);
            }
        }

        // Clear chat history
        function clearChatHistory() {
            if (confirm('Clear all chat history?')) {
                chatHistory = [];
                localStorage.removeItem('sqlChatHistory');
                document.getElementById('messages').innerHTML = '';
                document.getElementById('welcome').style.display = 'block';
            }
        }

        function updateFormFields() {
            document.getElementById('aiProvider').value = config.aiProvider;
            document.getElementById('apiKey').value = config.apiKey;
            document.getElementById('dbType').value = config.dbType;
            document.getElementById('dbHost').value = config.dbHost;
            document.getElementById('dbPort').value = config.dbPort;
            document.getElementById('dbName').value = config.dbName;
            document.getElementById('dbUser').value = config.dbUser;
            document.getElementById('dbPassword').value = config.dbPassword;
            updateApiKeyLabel();
        }

        function updateApiKeyLabel() {
            const provider = document.getElementById('aiProvider').value;
            document.getElementById('apiKeyLabel').textContent =
                provider === 'gemini' ? 'Gemini API Key' : 'OpenAI API Key';
        }

        function saveSettings() {
            config.aiProvider = document.getElementById('aiProvider').value;
            config.apiKey = document.getElementById('apiKey').value;
            config.dbType = document.getElementById('dbType').value;
            config.dbHost = document.getElementById('dbHost').value;
            config.dbPort = document.getElementById('dbPort').value;
            config.dbName = document.getElementById('dbName').value;
            config.dbUser = document.getElementById('dbUser').value;
            config.dbPassword = document.getElementById('dbPassword').value;

            localStorage.setItem('sqlChatConfig', JSON.stringify(config));

            showStatus('Settings saved successfully!', 'success');
            setTimeout(() => {
                closeSettings();
                fetchSchema();
            }, 1000);
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.add('open');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('open');
            document.getElementById('statusMessage').style.display = 'none';
        }

        function setMode(newMode) {
            mode = newMode;
            document.getElementById('aiModeBtn').classList.toggle('active', mode === 'ai');
            document.getElementById('sqlModeBtn').classList.toggle('active', mode === 'sql');
            document.getElementById('inputField').placeholder =
                mode === 'ai' ? 'Ask a question about your data...' : 'Enter SQL query (SELECT only)...';
        }

        async function fetchSchema() {
            if (!config.dbName) return;

            try {
                const response = await fetch('/api/schema', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const data = await response.json();
                schema = data.schema;
                document.getElementById('welcome').style.display = 'none';
            } catch (err) {
                console.error('Failed to fetch schema:', err);
            }
        }

        function openSchemaOverlay() {
            if (!config.dbName) {
                alert('Please configure your database settings first');
                openSettings();
                return;
            }

            document.getElementById('schemaOverlay').classList.add('open');
            loadSchemaDisplay();
        }

        function closeSchemaOverlay() {
            document.getElementById('schemaOverlay').classList.remove('open');
        }

        async function loadSchemaDisplay() {
            const bodyDiv = document.getElementById('schemaOverlayBody');
            bodyDiv.innerHTML = '<div class="schema-empty"><span class="material-icons">hourglass_empty</span><p>Loading schema...</p></div>';

            try {
                const response = await fetch('/api/schema', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch schema');
                }

                const data = await response.json();
                const schemaText = data.schema;

                if (!schemaText) {
                    bodyDiv.innerHTML = '<div class="schema-empty"><span class="material-icons">error_outline</span><p>No schema found</p></div>';
                    return;
                }

                // Parse schema text into structured data
                const tables = parseSchema(schemaText);

                if (tables.length === 0) {
                    bodyDiv.innerHTML = '<div class="schema-empty"><span class="material-icons">table_chart</span><p>No tables found</p></div>';
                    return;
                }

                // Render tables
                let html = '<div class="schema-tables">';
                tables.forEach(table => {
                    html += `
                        <div class="schema-table-card">
                            <div class="schema-table-name">
                                <span class="material-icons">table_chart</span>
                                ${escapeHtml(table.name)}
                            </div>
                            <div class="schema-columns">
                    `;

                    table.columns.forEach(col => {
                        html += `
                            <div class="schema-column">
                                <span class="schema-column-name">${escapeHtml(col.name)}</span>
                                <span class="schema-column-type">${escapeHtml(col.type)}</span>
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                bodyDiv.innerHTML = html;
            } catch (err) {
                bodyDiv.innerHTML = `<div class="schema-empty"><span class="material-icons">error</span><p>Error loading schema: ${escapeHtml(err.message)}</p></div>`;
            }
        }

        function parseSchema(schemaText) {
            const tables = [];
            const lines = schemaText.split('\n');
            let currentTable = null;

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                if (line.startsWith('Table:')) {
                    if (currentTable) {
                        tables.push(currentTable);
                    }
                    currentTable = {
                        name: line.replace('Table:', '').trim(),
                        columns: []
                    };
                } else if (line.startsWith('Columns:') && currentTable) {
                    const columnsText = line.replace('Columns:', '').trim();
                    const columnPairs = columnsText.split(',');

                    columnPairs.forEach(pair => {
                        const match = pair.trim().match(/^(.+?)\s*\((.+?)\)$/);
                        if (match) {
                            currentTable.columns.push({
                                name: match[1].trim(),
                                type: match[2].trim()
                            });
                        }
                    });
                }
            });

            if (currentTable) {
                tables.push(currentTable);
            }

            return tables;
        }

        async function sendMessage() {
            const input = document.getElementById('inputField');
            const query = input.value.trim();

            if (!query) return;

            if (!config.apiKey || !config.dbName) {
                alert('Please configure your settings first');
                openSettings();
                return;
            }

            document.getElementById('welcome').style.display = 'none';
            addUserMessage(query);

            // Save user message to history
            chatHistory.push({
                type: 'user',
                content: query,
                timestamp: new Date().toISOString()
            });
            saveChatHistory();

            input.value = '';

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;

            try {
                if (mode === 'sql') {
                    await executeDirectSQL(query);
                } else {
                    await executeAIQuery(query);
                }
            } catch (err) {
                addErrorMessage(err.message);
                // Save error to history
                chatHistory.push({
                    type: 'error',
                    content: err.message,
                    timestamp: new Date().toISOString()
                });
                saveChatHistory();
            } finally {
                sendBtn.disabled = false;
            }
        }

        async function executeDirectSQL(query) {
            const response = await fetch('/api/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...config, query })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Query execution failed');
            }

            const data = await response.json();
            addAssistantMessage(data.query, data.results);

            // Save assistant response to history
            chatHistory.push({
                type: 'assistant',
                sqlQuery: data.query,
                results: data.results,
                summary: null,
                timestamp: new Date().toISOString()
            });
            saveChatHistory();
        }

        async function executeAIQuery(query) {
            const response = await fetch('/api/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...config, query, schema })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Query generation failed');
            }

            const data = await response.json();
            addAssistantMessage(data.sql_query, data.results, data.summary);

            // Save assistant response to history
            chatHistory.push({
                type: 'assistant',
                sqlQuery: data.sql_query,
                results: data.results,
                summary: data.summary,
                timestamp: new Date().toISOString()
            });
            saveChatHistory();
        }

        function addUserMessage(text, scroll = true) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                <div class="avatar"><span class="material-icons">person</span></div>
                <div class="message-content">${escapeHtml(text)}</div>
            `;
            messagesDiv.appendChild(messageDiv);
            if (scroll) scrollToBottom();
        }

        function addAssistantMessage(sqlQuery, results, summary, scroll = true) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';

            let content = `<div class="avatar"><span class="material-icons">smart_toy</span></div><div class="message-content">`;

            if (sqlQuery) {
                content += `<div class="sql-block">${escapeHtml(sqlQuery)}</div>`;
            }

            if (summary) {
                content += `<p><strong>${escapeHtml(summary)}</strong></p>`;
            }

            if (results && results.length > 0) {
                content += '<div class="results-table">' + generateTable(results) + '</div>';
            } else {
                content += '<p>No results found.</p>';
            }

            content += '</div>';
            messageDiv.innerHTML = content;
            messagesDiv.appendChild(messageDiv);
            if (scroll) scrollToBottom();

            // Add scroll indicator for wide tables
            addScrollIndicator();
        }

        function addErrorMessage(text, scroll = true) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `
                <div class="avatar"><span class="material-icons">error</span></div>
                <div class="message-content" style="color: #c5221f;">${escapeHtml(text)}</div>
            `;
            messagesDiv.appendChild(messageDiv);
            if (scroll) scrollToBottom();
        }

        function generateTable(results) {
            if (!results || results.length === 0) return '';

            const headers = Object.keys(results[0]);
            let html = '<table><thead><tr>';
            headers.forEach(h => html += `<th>${escapeHtml(h)}</th>`);
            html += '</tr></thead><tbody>';

            results.forEach(row => {
                html += '<tr>';
                headers.forEach(h => {
                    const val = row[h];
                    html += `<td>${val === null ? 'NULL' : escapeHtml(String(val))}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        function addScrollIndicator() {
            // Add scroll indicator to tables that overflow
            setTimeout(() => {
                const tables = document.querySelectorAll('.results-table');
                tables.forEach(table => {
                    if (table.scrollWidth > table.clientWidth) {
                        table.classList.add('has-scroll');
                        // Remove indicator after user scrolls
                        table.addEventListener('scroll', function () {
                            this.classList.remove('has-scroll');
                        }, { once: true });
                    }
                });
            }, 100);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            const chatArea = document.getElementById('chatArea');
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Initialize app
        loadConfig();
        loadChatHistory();
        if (config.dbName) {
            fetchSchema();
        }
    </script>
</body>

</html>